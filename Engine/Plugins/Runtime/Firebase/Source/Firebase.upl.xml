<?xml version="1.0" encoding="utf-8"?>
<!-- Firebase plugin additions-->
<root xmlns:android="http://schemas.android.com/apk/res/android">
	<!-- init section is always evaluated once per architecture -->
	<init>
		<log text="Firebase init"/>

		<setBoolFromProperty result="bEnabled" ini="Engine" section="Firebase" property="FirebaseEnabled" default="false"/>
		<if condition="bEnabled">
			<true>
				<log text="Firebase enabled!"/>

				<!-- May need client sender ID for notification handling -->
				<!-- setStringFromProperty result="firebase-client-sender-id" ini="Engine" section="Firebase" property="FirebaseClientSenderID" default="" /-->
			</true>
		</if>
	</init>

	<androidManifestUpdates>
		<if condition="bEnabled">
			<true>
				<addElements tag="application">
					<service
					  android:name="com.epicgames.ue4.notifications.EpicFirebaseInstanceIDService"
					  android:exported="false" >
						<intent-filter>
							<action android:name="com.google.firebase.INSTANCE_ID_EVENT"/>
						</intent-filter>
					</service>
					<service
					  android:name="com.epicgames.ue4.notifications.EpicFirebaseMessagingService"
					  android:exported="false">
						<intent-filter>
							<action android:name="com.google.firebase.MESSAGING_EVENT"/>
						</intent-filter>
					</service>
				</addElements>
			</true>
		</if>
	</androidManifestUpdates>

	<buildscriptGradleAdditions>
		<if condition="bEnabled">
			<true>
				<insert>dependencies {
	classpath 'com.google.gms:google-services:4.0.1' // google-services plugin
}
</insert>
			</true>
		</if>
	</buildscriptGradleAdditions>

	<buildGradleAdditions>
		<if condition="bEnabled">
			<true>
				<!-- Needs to be same version number as play-services -->
				<insert>dependencies {
	implementation 'com.google.firebase:firebase-core:11.8.0'
	implementation 'com.google.firebase:firebase-messaging:11.8.0'
}

// init firebase
apply plugin: 'com.google.gms.google-services'
</insert>
			</true>
		</if>
	</buildGradleAdditions>

	<gradleCopies>
		<if condition="bEnabled">
			<true>
				<!-- Will need to revisit this if/when other plug-ins need to modify google-services.json -->
				<copyFile src="$S(BuildDir)/google-services.json" dst="$S(BuildDir)/gradle/app/google-services.json" force="false"/>
			</true>
		</if>
	</gradleCopies>

	<gameActivityImportAdditions>
		<if condition="bEnabled">
			<true>
				<insert>
	import android.text.TextUtils;
	import static com.epicgames.ue4.notifications.EpicFirebaseMessagingService.KEY_NOTIFICATION_BODY;
	import static com.epicgames.ue4.notifications.EpicFirebaseMessagingService.NOTIFICATION_ACTION;
	import static com.epicgames.ue4.services.VoiceService.VOICE_ACTION_UPDATED;
				</insert>
			</true>
		</if>
	</gameActivityImportAdditions>

		<!-- optional additions to GameActivity onResume in GameActivity.java -->
	<gameActivityOnResumeAdditions>
		<if condition="bEnabled">
			<true>
				<insert>
	if (NOTIFICATION_ACTION.equals(getIntent().getAction())) {
		handleNotificationAction();
	}
	else if(VOICE_ACTION_UPDATED.equals(getIntent().getAction())) {
		routeServiceIntent(getIntent());
	}
				</insert>
			</true>
		</if>f
	</gameActivityOnResumeAdditions>
	<!-- optional additions to the GameActivity class in GameActivity.java -->
	<gameActivityClassAdditions>
		<if condition="bEnabled">
			<true>
				<insertNewline />
				<insert>
	private void handleNotificationAction() {
		Bundle extras = getIntent().getExtras();
		if (extras != null) {
			String body = extras.getString(KEY_NOTIFICATION_BODY);
			if(!TextUtils.isEmpty(body)) {
				routeNotificationAction(body);
			}
		}
		Intent i = getIntent();
		i.setAction(null);
		setIntent(i);
	}
				</insert>
				<insertNewline />
				<insert>
	@Override
	public void routeNotificationAction(String payload) {
		super.routeNotificationAction(payload);
	}
				</insert>
				<insertNewline />
			</true>
		</if>
	</gameActivityClassAdditions>
</root>
